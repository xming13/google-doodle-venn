<html>
<head>
	<meta charset="uft-8">
    <title>Google Doodle Venn</title>
	<style type="text/css">
		#canvas { 
			background:url(images/background.png);
			margin: 0 auto;
			display: block;
		}
	</style>
</head>
<body>
	<canvas id="canvas" width="600" height="220">
		This text is displayed if your browser does not support HTML5 Canvas.
	</canvas>
</body>  
<script src="js/requestAnimFrame.js"></script>
<script src="js/sprite-manager.js"></script>
<script src="js/animation-manager.js"></script>
<script type="text/javascript">
	
	var Venns = new function() {
		// declare the variables
		var	requestID			= null,
			canvas 				= null,
			context 			= null,
			smallLeftIcons		= null,
			smallRightIcons 	= null,
			bigLeftIcons 		= null,
			bigRightIcons	 	= null,
			bigDefaultLeftIcon  = null,
			bigDefaultRightIcon = null,
			selectedLeftIcon 	= null,
			selectedRightIcon 	= null,
			requireCenterRender	= false,
			selectedAnimation   = null,
			leftIconMapping 	= ['Mammals', 'Musical', 'Transport', 'Vegetation', 'Sea Life'],
			rightIconMapping	= [
									[
										{ index: 0, text: 'Tiny', animIndex: 3},
										{ index: 1, text: 'Has Wings', animIndex: 0},
										{ index: 4, text: 'Thrives in Cold', animIndex: 4},
										{ index: 7, text: 'Has a Shell', animIndex: 2},
										{ index: 9, text: 'Mythical', animIndex: 1}
									],
								 	[
										{ index: 0, text: 'Tiny', animIndex: 8},
										{ index: 1, text: 'Has Wings', animIndex: 9},
										{ index: 4, text: 'Thrives in Cold', animIndex: 6}, 
										{ index: 5, text: 'Spiral-Shaped', animIndex: 7},
										{ index: 8, text: 'In Space', animIndex: 5}
									],
									[
										{ index: 0, text: 'Tiny', animIndex: 15},
										{ index: 1, text: 'Has Wings', animIndex: 16},
										{ index: 4, text: 'Thrives in Cold', animIndex: 17},
										{ index: 6, text: 'Leaves a Trail', animIndex: 18},
										{ index: 8, text: 'In Space', animIndex: 19}
									],
									[
										{ index: 0, text: 'Tiny', animIndex: 3},
										{ index: 2, text: 'Can Fly', animIndex: 3},
										{ index: 3, text: 'Cone-Shaped', animIndex: 3},
										{ index: 7, text: 'Has a Shell', animIndex: 3},
										{ index: 9, text: 'Mythical', animIndex: 3}
									],
									[
										{ index: 0, text: 'Tiny', animIndex: 14},
										{ index: 1, text: 'Has Wings', animIndex: 10},
										{ index: 4, text: 'Thrives in Cold', animIndex: 12},
										{ index: 7, text: 'Has a Shell', animIndex: 13},
										{ index: 9, text: 'Mythical', animIndex: 11}
									],
								  ],
			bigLeftIconCenterX 	= 150,
			bigRightIconCenterX = 450,
			distSmallLeftIcon 	= 122,
			distSmallRightIcon  = 0,
			tick				= 0,
			iconIndexRotate		= 0;
			
		// declare constants
		var BIG_LEFT_ICON_CENTER_X_FINAL	= 264,
			BIG_RIGHT_ICON_CENTER_X_FINAL	= 336,
			BIG_LEFT_ICON_CENTER_Y 			= 109,
			BIG_RIGHT_ICON_CENTER_Y 		= 109,
			CENTER_X_FINAL					= 300,
			CENTER_Y_FINAL					= 109,
			BIG_ICON_RADIUS 				= 89,
			SMALL_ICON_DIST					= 122,
			TYPE_ICON_LEFT 					= 'left',
			TYPE_ICON_RIGHT 				= 'right';
			
		var colors = ['#FF0000', '#FFFF00', '#0000FF'];
		
		// init method
		this.initialize = function() {
			canvas = document.getElementById("canvas");
			context = canvas.getContext('2d');
			
			XMing.SpriteManager.init();
			XMing.AnimationManager.init();
			smallLeftIcons		= XMing.SpriteManager.smallLeftIcons;
			smallRightIcons 	= XMing.SpriteManager.smallRightIcons;
			bigLeftIcons 		= XMing.SpriteManager.bigLeftIcons;
			bigRightIcons	 	= XMing.SpriteManager.bigRightIcons;
			bigDefaultLeftIcon  = XMing.SpriteManager.bigDefaultLeftIcon;
			bigDefaultRightIcon = XMing.SpriteManager.bigDefaultRightIcon;
		
			canvas.addEventListener("mousemove", onMouseMove, false);
			canvas.addEventListener("click", onClick, false);
			
			this.update();
		},
		this.reset = function() {
			cancelAnimationFrame(requestID);
			canvas 				= null,
			context 			= null,
			smallLeftIcons		= [],
			smallRightIcons 	= [],
			bigLeftIcons 		= [],
			bigRightIcons	 	= [],
			bigDefaultLeftIcon  = null,
			bigDefaultRightIcon = null,
			selectedLeftIcon 	= null;
			selectedRightIcon 	= null,
			requireCenterRender	= false,
			bigLeftIconCenterX 	= 150,
			bigRightIconCenterX = 450,
			distSmallLeftIcon 	= 122,
			distSmallRightIcon  = 0,
			tick				= 0,
			iconIndexRotate 	= 0;
			initialize();
		},		
		// The main loop where everything happens
		this.update = function() {
			requestID = requestAnimFrame(this.update.bind(this));
			this.draw();
		},
		// draw method
		this.draw = function() {
			tick++;
			
			this.rotateSmallIcon();

			context.clearRect(0, 0, canvas.width, canvas.height);
			
			if (selectedLeftIcon) {
				// set Text based on selectedLeftIcon
				context.font = '14px Arial';
				context.textAlign = 'center';
				context.fillText(leftIconMapping[selectedLeftIcon.index], 
					bigLeftIconCenterX, 
					BIG_LEFT_ICON_CENTER_Y - BIG_ICON_RADIUS - 4
				);
				
				if (!selectedRightIcon) {
					// animate smallLeftIcon to center of BigLeftIcon
					if (distSmallLeftIcon > 0) {
						distSmallLeftIcon -= 3;
					}
					
					if (distSmallLeftIcon > BIG_ICON_RADIUS) {
						bigDefaultLeftIcon.alpha = 0.4;
						bigDefaultLeftIcon.copyImage(bigLeftIcons[selectedLeftIcon.index]);
					} 
					else {
						if (bigDefaultLeftIcon.alpha + 0.015 < 1.0) {
							bigDefaultLeftIcon.alpha += 0.015;
						}
						else {
							bigDefaultLeftIcon.alpha = 1.0;
						}
					}
					
					var isFinishedAnim = true;
					for (var i = 0; i < smallLeftIcons.length; i++) {
						var icon = smallLeftIcons[i];
						if (icon.alpha - 0.05 > 0) {
							icon.alpha -= 0.05;
							isFinishedAnim = false;
						} 
						else {
							icon.alpha = 0.0;								
						}
					}

					if (isFinishedAnim && distSmallLeftIcon <= 0) {					
						// animate the right small icons from center to outer
						if (distSmallRightIcon + 3 < SMALL_ICON_DIST) {
							distSmallRightIcon += 3;
						}
						else {
							distSmallRightIcon = SMALL_ICON_DIST;
						}
					}
				}
			}
			if (selectedRightIcon) {		
				// set Text based on selectedRightIcon
				context.font = '14px Arial';
				context.textAlign = 'center';
				context.fillText(rightIconMapping[selectedLeftIcon.index][selectedRightIcon.index].text, 
					bigRightIconCenterX, 
					BIG_RIGHT_ICON_CENTER_Y - BIG_ICON_RADIUS - 4
				);		
				
				// set selected Animation based on the combination of the selected left and right choices
				if (!selectedAnimation) {
					var animIndex = rightIconMapping[selectedLeftIcon.index][selectedRightIcon.index].animIndex;
					selectedAnimation = XMing.AnimationManager.getAnimation(animIndex);
				}
				
				// animate smallRightIcon to center of BigRightIcon
				if (distSmallRightIcon > 0) {
					distSmallRightIcon -= 3;
				}
				if (distSmallRightIcon > BIG_ICON_RADIUS) {
					bigDefaultRightIcon.alpha = 0.4;
					var index = rightIconMapping[selectedLeftIcon.index][selectedRightIcon.index].index;
					bigDefaultRightIcon.copyImage(bigRightIcons[index]);
				} 
				else {
					if (bigDefaultRightIcon.alpha + 0.015 < 1) {
						bigDefaultRightIcon.alpha += 0.015;
					}
					else {
						bigDefaultRightIcon.alpha = 1.0;
					}
				}
				var isFinishedAnim = true;
				for (var i = 0; i < smallRightIcons.length; i++) {
					var icon = smallRightIcons[i];
					if (icon.alpha - 0.05 > 0) {
						icon.alpha -= 0.05;
						isFinishedAnim = false;
					} 
					else {
						icon.alpha = 0.0;
					}
				}
				
				// smallRightIcon finish animate to center of BigRightIcon
				// start animate BigIcons to center
				if (isFinishedAnim && distSmallRightIcon <= 0) {
					requireCenterRender = true;
					var speed = 7;
					
					// animate bigLeftIcon to center of the canvas				
					if (bigLeftIconCenterX > BIG_LEFT_ICON_CENTER_X_FINAL + speed) {
						bigLeftIconCenterX = BIG_LEFT_ICON_CENTER_X_FINAL + speed;
					} 
					else if (bigLeftIconCenterX == BIG_LEFT_ICON_CENTER_X_FINAL + speed) {
						bigLeftIconCenterX = BIG_LEFT_ICON_CENTER_X_FINAL;
					}
					else if (bigLeftIconCenterX != BIG_LEFT_ICON_CENTER_X_FINAL) {
						bigLeftIconCenterX += speed;
					}
				
					// animate bigRightIcon to center of the canvas					
					if (bigRightIconCenterX < BIG_RIGHT_ICON_CENTER_X_FINAL - speed) {
						bigRightIconCenterX = BIG_RIGHT_ICON_CENTER_X_FINAL - speed;
					} 
					else if (bigRightIconCenterX == BIG_RIGHT_ICON_CENTER_X_FINAL - speed) {
						bigRightIconCenterX = BIG_RIGHT_ICON_CENTER_X_FINAL;
					}
					else if (bigRightIconCenterX != BIG_RIGHT_ICON_CENTER_X_FINAL) {
						bigRightIconCenterX -= speed;
					}
					
					// big icons finish animating to center of the canvas
					if (bigLeftIconCenterX == BIG_LEFT_ICON_CENTER_X_FINAL &&
						bigRightIconCenterX == BIG_RIGHT_ICON_CENTER_X_FINAL) {
						// start center animation
						if (selectedAnimation.alpha + 0.01 < 1.0) {
							selectedAnimation.alpha += 0.01;
							selectedAnimation.start();
						}
						else {
							selectedAnimation.alpha = 1.0;
							requireCenterRender = false;
						}
					}
				}	
			}
			
			// render smallLeftIcons
			for (var i = 0; i < smallLeftIcons.length; i++) {
				smallLeftIcons[i].render(
					context,
					bigLeftIconCenterX - Math.cos((45.0 - i * 22.5) / 180.0 * Math.PI) * distSmallLeftIcon, 
					BIG_LEFT_ICON_CENTER_Y - Math.sin((45.0 - i * 22.5) / 180.0 * Math.PI) * distSmallLeftIcon
				);
			}
			
			// render smallRightIcons
			for (var i = 0; i < smallRightIcons.length; i++) {
				smallRightIcons[i].render(
					context,
					bigRightIconCenterX + Math.cos((45.0 - i * 22.5) / 180.0 * Math.PI) * distSmallRightIcon,
					BIG_RIGHT_ICON_CENTER_Y - Math.sin((45.0 - i * 22.5) / 180.0 * Math.PI) * distSmallRightIcon
				);
			}
			
			// render bigDefaultLeftIcon and bigDefaultRightIcon
			bigDefaultLeftIcon.render(context,bigLeftIconCenterX, BIG_LEFT_ICON_CENTER_Y);
			bigDefaultRightIcon.render(context,bigRightIconCenterX, BIG_RIGHT_ICON_CENTER_Y);
			
			// render center
			if (requireCenterRender) {
				this.renderOverlappedCenter(bigLeftIconCenterX, bigRightIconCenterX);
			}
			
			// render selectedAnimation
			if (selectedAnimation && selectedAnimation.isStarted) {
				selectedAnimation.render(context);
			}
		},
		this.renderOverlappedCenter = function(leftCenterX, rightCenterX) {
			this.centerX = CENTER_X_FINAL;
			this.centerY = CENTER_Y_FINAL;
			context.save();
			context.globalAlpha = 1.0;
			context.beginPath();
			
			var distX = (rightCenterX - leftCenterX) / 2;
			var radian = Math.acos(distX / BIG_ICON_RADIUS);
			
			context.arc(leftCenterX, BIG_LEFT_ICON_CENTER_Y, BIG_ICON_RADIUS, 
				-1 * radian, radian, false);
			context.arc(rightCenterX, BIG_RIGHT_ICON_CENTER_Y, BIG_ICON_RADIUS, 
				Math.PI - radian, Math.PI + radian, false);
			context.closePath();
			context.clip();
			context.fillStyle = '#f3f3f3';
			context.fill();
			context.restore();
		},
		this.rotateSmallIcon = function() {			
			if (tick > 160) {
				if (!selectedLeftIcon) {
					smallLeftIcons[iconIndexRotate].rotateRad = 0;	
					iconIndexRotate = (iconIndexRotate + 1) % smallLeftIcons.length;
				} 
				else if (!selectedRightIcon) {
					smallRightIcons[iconIndexRotate].rotateRad = 0;
					iconIndexRotate = (iconIndexRotate + 1) % smallRightIcons.length;
				}

				tick = 0;
			} 
			else {
				if (!selectedLeftIcon) {
					smallLeftIcons[iconIndexRotate].updateRotateRad(tick);
				}
				else if (!selectedRightIcon) {
					smallRightIcons[iconIndexRotate].updateRotateRad(tick);
				}
			}
		}
		
		
		function onMouseMove(event) {
			var mousePos = getMousePos(this, event);
			
			var icons = smallLeftIcons.concat(smallRightIcons);
			
			var isHover = false;
			for (var i = 0; i < icons.length; i++) {
				
				var icon = icons[i];
				if ((icon.type == TYPE_ICON_LEFT && !selectedLeftIcon)
					|| (icon.type == TYPE_ICON_RIGHT && selectedLeftIcon && !selectedRightIcon))
				{
					var startX = icon.centerX - icon.width / 2;
					var endX = icon.centerX + icon.width / 2;
					var startY = icon.centerY - icon.height / 2;
					var endY = icon.centerY + icon.height / 2;
					
					if (mousePos.x >= startX 
						&& mousePos.x <= endX
						&& mousePos.y >= startY 
						&& mousePos.y <= endY) {
						icon.setHover(true);
						isHover = true;
					} 
					else {
						icon.setHover(false);
					}
				}
			}
			canvas.style.cursor = isHover ? 'pointer' : 'auto';
		}
		
		function onClick(event) {
			var mousePos = getMousePos(this, event);

			var icons = smallLeftIcons.concat(smallRightIcons);
			for (var i = 0; i < icons.length; i++) {
				var icon = icons[i];
				
				i
				if ((icon.type == TYPE_ICON_LEFT && !selectedLeftIcon)
					|| (icon.type == TYPE_ICON_RIGHT && selectedLeftIcon && !selectedRightIcon))
				{
					var startX = icon.centerX - icon.width / 2;
					var endX = icon.centerX + icon.width / 2;
					var startY = icon.centerY - icon.height / 2;
					var endY = icon.centerY + icon.height / 2;

					if (mousePos.x >= startX && mousePos.x <= endX
						&& mousePos.y >= startY && mousePos.y <= endY) {
						if (icon.type == TYPE_ICON_LEFT) {
							selectedLeftIcon = icon;
							iconIndexRotate = 0;
						} 
						else if (icon.type == TYPE_ICON_RIGHT) {
							selectedRightIcon = icon;			
						}
					}
				}
			}
		}
		
		function getMousePos(canvas, evt) {
			var rect = canvas.getBoundingClientRect();
			return {
			  x: evt.clientX - rect.left,
			  y: evt.clientY - rect.top
			};
		}
	};
		
	// Go
	window.onload = function() {
		Venns.initialize();
	};
	
</script>
</html>